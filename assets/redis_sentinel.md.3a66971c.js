import{_ as e,c as n,o as s,a as t}from"./app.64b20f26.js";const k=`{"title":"Redis Sentinel","description":"","frontmatter":{"slug":"sentinel","title":"Redis Sentinel"},"headers":[{"level":3,"title":"Usage","slug":"usage"},{"level":3,"title":"Start monitoring Sentinels","slug":"start-monitoring-sentinels"},{"level":3,"title":"Advanced Sentinel Configuration","slug":"advanced-sentinel-configuration"},{"level":3,"title":"Custom Redis Connection String","slug":"custom-redis-connection-string"},{"level":3,"title":"Other RedisSentinel Configuration","slug":"other-redissentinel-configuration"},{"level":2,"title":"Configure Redis Sentinel Servers","slug":"configure-redis-sentinel-servers"},{"level":3,"title":"Windows Usage","slug":"windows-usage"},{"level":3,"title":"Localhost vs Network IP's","slug":"localhost-vs-network-ip-s"},{"level":3,"title":"Google Cloud - Click to Deploy Redis","slug":"google-cloud-click-to-deploy-redis"},{"level":3,"title":"Change to use RedisManagerPool","slug":"change-to-use-redismanagerpool"},{"level":3,"title":"Start monitoring Sentinels","slug":"start-monitoring-sentinels-1"},{"level":2,"title":"Configure Redis Sentinel Servers","slug":"configure-redis-sentinel-servers-1"},{"level":3,"title":"Redis Stats","slug":"redis-stats"},{"level":2,"title":"Automatic Retries","slug":"automatic-retries"}],"relativePath":"redis/sentinel.md","lastUpdated":1645007721741}`,a={},o=t(`<p><a href="http://redis.io/topics/sentinel" target="_blank" rel="noopener noreferrer">Redis Sentinel</a> is the official recommendation for running a highly available Redis configuration by running a number of additional redis sentinel processes to actively monitor existing redis master and slave instances ensuring they&#39;re each working as expected. If by consensus it&#39;s determined that the master is no longer available it will automatically failover and promote one of the replicated slaves as the new master. The sentinels also maintain an authoritative list of available redis instances providing clients a centeral repositorty to discover available instances they can connect to.</p><p>Support for Redis Sentinel is available with the <code>RedisSentinel</code> class which listens to the available Sentinels to source its list of available master, slave and other sentinel redis instances which it uses to configure and maintain the Redis Client Managers, initiating any failovers as they&#39;re reported.</p><h3 id="usage" tabindex="-1">Usage <a class="header-anchor" href="#usage" aria-hidden="true">#</a></h3><p>To use the new Sentinel support, instead of populating the Redis Client Managers with the connection string of the master and slave instances you would create a single <code>RedisSentinel</code> instance configured with the connection string of the running Redis Sentinels:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> sentinelHosts <span class="token operator">=</span> <span class="token keyword">new</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span> <span class="token string">&quot;sentinel1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sentinel2:6390&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;sentinel3&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token class-name"><span class="token keyword">var</span></span> sentinel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisSentinel</span><span class="token punctuation">(</span>sentinelHosts<span class="token punctuation">,</span> <span class="token named-parameter punctuation">masterName</span><span class="token punctuation">:</span> <span class="token string">&quot;mymaster&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This shows a typical example of configuring a <code>RedisSentinel</code> which references 3 sentinel hosts (i.e. the minimum number for a highly available setup which can survive any node failing). It&#39;s also configured to look at the <code>mymaster</code> configuration set (the default master group).</p><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Redis Sentinels can monitor more than 1 master / slave group, each with a different master group name.</p></div><p>The default port for sentinels is <strong>26379</strong> (when unspecified) and as RedisSentinel can auto-discover other sentinels, the minimum configuration required is just:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> sentinel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisSentinel</span><span class="token punctuation">(</span><span class="token string">&quot;sentinel1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="info custom-block"><p class="custom-block-title">INFO</p><p>Scanning and auto discovering of other Sentinels can be disabled with <code>ScanForOtherSentinels=false</code></p></div><h3 id="start-monitoring-sentinels" tabindex="-1">Start monitoring Sentinels <a class="header-anchor" href="#start-monitoring-sentinels" aria-hidden="true">#</a></h3><p>Once configured, you can start monitoring the Redis Sentinel servers and access the pre-configured client manager with:</p><div class="language-csharp"><pre><code><span class="token class-name">IRedisClientsManager</span> redisManager <span class="token operator">=</span> sentinel<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which as before, can be registered in your preferred IOC as a <strong>singleton</strong> instance:</p><div class="language-csharp"><pre><code>container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IRedisClientsManager<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> sentinel<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="advanced-sentinel-configuration" tabindex="-1">Advanced Sentinel Configuration <a class="header-anchor" href="#advanced-sentinel-configuration" aria-hidden="true">#</a></h3><p>RedisSentinel by default manages a configured <code>PooledRedisClientManager</code> instance which resolves both master Redis clients for read/write <code>GetClient()</code> and slaves for readonly <code>GetReadOnlyClient()</code> API&#39;s.</p><p>This can be changed to use the newer <code>RedisManagerPool</code> with:</p><div class="language-csharp"><pre><code>sentinel<span class="token punctuation">.</span>RedisManagerFactory <span class="token operator">=</span> <span class="token punctuation">(</span>master<span class="token punctuation">,</span>slaves<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisManagerPool</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="custom-redis-connection-string" tabindex="-1">Custom Redis Connection String <a class="header-anchor" href="#custom-redis-connection-string" aria-hidden="true">#</a></h3><p>The host the RedisSentinel is configured with only applies to that Sentinel Host, you can still use the flexibility of <a href="https://github.com/ServiceStack/ServiceStack.Redis#redis-connection-strings" target="_blank" rel="noopener noreferrer">Redis Connection Strings</a> to configure the individual Redis Clients by specifying a custom <code>HostFilter</code>:</p><div class="language-csharp"><pre><code>sentinel<span class="token punctuation">.</span>HostFilter <span class="token operator">=</span> host <span class="token operator">=&gt;</span> <span class="token string">&quot;{0}?db=1&amp;RetryTimeout=5000&quot;</span><span class="token punctuation">.</span><span class="token function">Fmt</span><span class="token punctuation">(</span>host<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>This will return clients configured to use Database 1 and a Retry Timeout of 5 seconds (used in new Auto Retry feature).</p><h3 id="other-redissentinel-configuration" tabindex="-1">Other RedisSentinel Configuration <a class="header-anchor" href="#other-redissentinel-configuration" aria-hidden="true">#</a></h3><p>Whilst the above covers the popular Sentinel configuration that would typically be used, nearly every aspect of <code>RedisSentinel</code> behavior is customizable with the configuration below:</p><table><tr><td><b>OnSentinelMessageReceived</b></td><td>Fired when the Sentinel worker receives a message from the Sentinel Subscription</td></tr><tr><td><b>OnFailover</b></td><td>Fired when Sentinel fails over the Redis Client Manager to a new master</td></tr><tr><td><b>OnWorkerError</b></td><td>Fired when the Redis Sentinel Worker connection fails</td></tr><tr><td><b>IpAddressMap</b></td><td>Map internal redis host IP&#39;s returned by Sentinels to its external IP</td></tr><tr><td><b>ScanForOtherSentinels</b></td><td>Whether to routinely scan for other sentinel hosts (default true)</td></tr><tr><td><b>RefreshSentinelHostsAfter</b></td><td>What interval to scan for other sentinel hosts (default 10 mins)</td></tr><tr><td><b>WaitBetweenFailedHosts</b></td><td>How long to wait after failing before connecting to next redis instance (default 250ms)</td></tr><tr><td><b>MaxWaitBetweenFailedHosts</b></td><td>How long to retry connecting to hosts before throwing (default 60s)</td></tr><tr><td><b>WaitBeforeForcingMasterFailover</b></td><td>How long after consecutive failed attempts to force failover (default 60s)</td></tr><tr><td><b>ResetWhenSubjectivelyDown</b></td><td>Reset clients when Sentinel reports redis is subjectively down (default true)</td></tr><tr><td><b>ResetWhenObjectivelyDown</b></td><td>Reset clients when Sentinel reports redis is objectively down (default true)</td></tr><tr><td><b>SentinelWorkerConnectTimeoutMs</b></td><td>The Max Connection time for Sentinel Worker (default 100ms)</td></tr><tr><td><b>SentinelWorkerSendTimeoutMs</b></td><td>Max TCP Socket Send time for Sentinel Worker (default 100ms)</td></tr><tr><td><b>SentinelWorkerReceiveTimeoutMs</b></td><td>Max TCP Socket Receive time for Sentinel Worker (default 100ms)</td></tr></table><h2 id="configure-redis-sentinel-servers" tabindex="-1"><a href="https://github.com/ServiceStack/redis-config" target="_blank" rel="noopener noreferrer">Configure Redis Sentinel Servers</a> <a class="header-anchor" href="#configure-redis-sentinel-servers" aria-hidden="true">#</a></h2><p><a href="https://github.com/ServiceStack/redis-config" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/redis/instant-sentinel-setup.png" alt="Instant Redis Setup"></a></p><p>The <a href="https://github.com/ServiceStack/redis-config" target="_blank" rel="noopener noreferrer">redis config project</a> simplifies setting up and running a highly-available multi-node Redis Sentinel configuration including start/stop scripts for instantly setting up the minimal <a href="https://github.com/ServiceStack/redis-config/blob/master/README.md#3x-sentinels-monitoring-1x-master-and-2x-slaves" target="_blank" rel="noopener noreferrer">highly available Redis Sentinel configuration</a> on a single (or multiple) Windows, OSX or Linux servers. This single-server/multi-process configuration is ideal for setting up a working sentinel configuration on a single dev workstation or remote server.</p><p>The redis-config repository also includes the <a href="https://github.com/ServiceStack/redis-windows#running-microsofts-native-port-of-redis" target="_blank" rel="noopener noreferrer">MS OpenTech Windows redis binaries</a> and doesn&#39;t require any software installation.</p><h3 id="windows-usage" tabindex="-1">Windows Usage <a class="header-anchor" href="#windows-usage" aria-hidden="true">#</a></h3><p>To run the included Sentinel configuration, clone the redis-config repo on the server you want to run it on:</p><div class="language-"><pre><code>git clone https://github.com/ServiceStack/redis-config.git
</code></pre></div><p>Then Start 1x Master, 2x Slaves and 3x Sentinel redis-servers with:</p><div class="language-"><pre><code>cd redis-config\\sentinel3\\windows
start-all.cmd
</code></pre></div><p>Shutdown started instances:</p><div class="language-"><pre><code>stop-all.cmd
</code></pre></div><p>If you&#39;re running the redis processes locally on your dev workstation the minimal configuration to connect to the running instances is just:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> sentinel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisSentinel</span><span class="token punctuation">(</span><span class="token string">&quot;127.0.0.1:26380&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> sentinel<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="localhost-vs-network-ip-s" tabindex="-1">Localhost vs Network IP&#39;s <a class="header-anchor" href="#localhost-vs-network-ip-s" aria-hidden="true">#</a></h3><p>The sentinel configuration assumes all redis instances are running locally on <strong>127.0.0.1</strong>. If you&#39;re instead running it on a remote server that you want all developers in your network to be able to access, you&#39;ll need to either change the IP Address in the <code>*.conf</code> files to use the servers Network IP. Otherwise you can leave the defaults and use the <code>RedisSentinel</code> IP Address Map feature to transparently map localhost IP&#39;s to the Network IP that each pc on your network can connect to.</p><p>E.g. if this is running on a remote server with a <strong>10.0.0.9</strong> Network IP, it can be configured with:</p><div class="language-csharp"><pre><code><span class="token class-name"><span class="token keyword">var</span></span> sentinel <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisSentinel</span><span class="token punctuation">(</span><span class="token string">&quot;10.0.0.9:26380&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    IpAddressMap <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token punctuation">{</span><span class="token string">&quot;127.0.0.1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;10.0.0.9&quot;</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
container<span class="token punctuation">.</span><span class="token function">Register</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> sentinel<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="google-cloud-click-to-deploy-redis" tabindex="-1">Google Cloud - <a href="https://github.com/ServiceStack/redis-config/blob/master/README.md#google-cloud---click-to-deploy-redis" target="_blank" rel="noopener noreferrer">Click to Deploy Redis</a> <a class="header-anchor" href="#google-cloud-click-to-deploy-redis" aria-hidden="true">#</a></h3><p>The easiest Cloud Service we&#39;ve found that can instantly set up a multi node-Redis Sentinel Configuration is using Google Cloud&#39;s <a href="https://cloud.google.com/solutions/redis/click-to-deploy" target="_blank" rel="noopener noreferrer">click to deploy Redis feature</a> available from the Google Cloud Console under <strong>Deploy &amp; Manage</strong>:</p><p><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/redis/sentinel3-gcloud-01.png" alt=""></p><p>Clicking <strong>Deploy</strong> button will let you configure the type, size and location where you want to deploy the Redis VM&#39;s. See the <a href="https://github.com/ServiceStack/redis-config/blob/master/README.md#google-cloud---click-to-deploy-redis" target="_blank" rel="noopener noreferrer">full Click to Deploy Redis guide</a> for a walk-through on setting up and inspecting a highly-available redis configuration on Google Cloud.</p><h3 id="change-to-use-redismanagerpool" tabindex="-1">Change to use RedisManagerPool <a class="header-anchor" href="#change-to-use-redismanagerpool" aria-hidden="true">#</a></h3><p>By default, RedisSentinel uses a <code>PooledRedisClientManager</code>, this can be changed to use the newer <code>RedisManagerPool</code> with:</p><div class="language-csharp"><pre><code>sentinel<span class="token punctuation">.</span>RedisManagerFactory <span class="token operator">=</span> <span class="token punctuation">(</span>master<span class="token punctuation">,</span>replicas<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token constructor-invocation class-name">RedisManagerPool</span><span class="token punctuation">(</span>master<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="start-monitoring-sentinels-1" tabindex="-1">Start monitoring Sentinels <a class="header-anchor" href="#start-monitoring-sentinels-1" aria-hidden="true">#</a></h3><p>Once configured, you can start monitoring the Redis Sentinel servers and access the pre-configured client manager with:</p><div class="language-csharp"><pre><code><span class="token class-name">IRedisClientsManager</span> redisManager <span class="token operator">=</span> sentinel<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Which as before, can be registered in your preferred IOC as a <strong>singleton</strong> instance:</p><div class="language-csharp"><pre><code>container<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Register</span><span class="token generic class-name"><span class="token punctuation">&lt;</span>IRedisClientsManager<span class="token punctuation">&gt;</span></span></span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> sentinel<span class="token punctuation">.</span><span class="token function">Start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="configure-redis-sentinel-servers-1" tabindex="-1"><a href="https://github.com/ServiceStack/redis-config" target="_blank" rel="noopener noreferrer">Configure Redis Sentinel Servers</a> <a class="header-anchor" href="#configure-redis-sentinel-servers-1" aria-hidden="true">#</a></h2><p><a href="https://github.com/ServiceStack/redis-config" target="_blank" rel="noopener noreferrer"><img src="https://raw.githubusercontent.com/ServiceStack/Assets/master/img/redis/instant-sentinel-setup.png" alt="Instant Redis Setup"></a></p><p>See the <a href="https://github.com/ServiceStack/redis-config" target="_blank" rel="noopener noreferrer">redis config project</a> for a quick way to setup up the minimal <a href="https://github.com/ServiceStack/redis-config/blob/master/README.md#3x-sentinels-monitoring-1x-master-and-2x-slaves" target="_blank" rel="noopener noreferrer">highly available Redis Sentinel configuration</a> including start/stop scripts for instantly running multiple redis instances on a single (or multiple) Windows, OSX or Linux servers.</p><h3 id="redis-stats" tabindex="-1"><a href="./stats.html">Redis Stats</a> <a class="header-anchor" href="#redis-stats" aria-hidden="true">#</a></h3><p>You can use the <code>RedisStats</code> class for visibility and introspection into your running instances. The <a href="./stats.html">Redis Stats wiki</a> lists the stats available.</p><h2 id="automatic-retries" tabindex="-1"><a href="./automatic-retries.html">Automatic Retries</a> <a class="header-anchor" href="#automatic-retries" aria-hidden="true">#</a></h2><p>To improve the resilience of client connections, <code>RedisClient</code> will transparently retry failed Redis operations due to Socket and I/O Exceptions in an exponential backoff starting from <strong>10ms</strong> up until the <code>RetryTimeout</code> of <strong>10000ms</strong>. These defaults can be tweaked with:</p><div class="language-csharp"><pre><code>RedisConfig<span class="token punctuation">.</span>DefaultRetryTimeout <span class="token operator">=</span> <span class="token number">10000</span><span class="token punctuation">;</span>
RedisConfig<span class="token punctuation">.</span>BackOffMultiplier <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>
</code></pre></div>`,63),i=[o];function r(c,l,p,d,u,g){return s(),n("div",null,i)}var f=e(a,[["render",r]]);export{k as __pageData,f as default};
